 <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RADAR - Real-Time Anomaly Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<style>
    :root { --grad: linear-gradient(135deg,#667eea,#764ba2); }

    body {
        margin:0;
        font-family:'Segoe UI',sans-serif;
        background: var(--grad);
        color:#222;
    }

    /* NAVBAR */
    .navbar {
        position:fixed; top:0; left:0; right:0; height:62px;
        background:#fff;
        z-index:9999;
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:0 22px;
        box-shadow:0 5px 18px rgba(0,0,0,0.15);
        font-weight:700;
    }
    .navbar .title { font-size:18px; font-weight:700; color:#444; }

    /* Layout */
    .container {
        max-width:1400px;
        margin:84px auto 30px;
        padding:0 16px;
    }

    /* Controls */
    .controls {
        display:flex; gap:8px; align-items:center;
        flex-wrap:wrap; margin-bottom:12px;
    }
    .btn {
        padding:5px 10px;
        border-radius:12px;
        background:rgba(255,255,255,0.16);
        border:1px solid rgba(255,255,255,0.18);
        font-size:13px;
        color:#fff;
        cursor:pointer;
    }
    .btn.active { background:#fff; color:#333; border-color:#ccc; }

    input[type="datetime-local"] {
        padding:6px; border-radius:6px;
        border:1px solid #ccc; background:#fff;
    }

    .card {
        background:#fff;
        padding:14px;
        border-radius:12px;
        box-shadow:0 6px 18px rgba(0,0,0,0.12);
        margin-bottom:16px;
    }

    /* Metrics */
    .metrics { display:flex; gap:12px; }
    .metric { flex:1; padding:16px; border-radius:10px; color:#fff; text-align:center; }
    .m1 { background:linear-gradient(135deg,#f093fb,#f5576c); }
    .m2 { background:linear-gradient(135deg,#4facfe,#00f2fe); }
    .m3 { background:linear-gradient(135deg,#43e97b,#38f9d7); }

    /* Grid */
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col-2 { flex:2; }
    .col-1 { flex:1; }

    /* Anomaly List */
    #anomalyList { list-style:none; padding:0; max-height:420px; overflow-y:auto; }
    #anomalyList li {
        background:#fafafa; border-left:5px solid #ef4b4b;
        margin-bottom:8px; padding:12px; border-radius:8px;
        cursor:pointer;
    }

    .sev { padding:4px 8px; border-radius:8px; font-size:12px; font-weight:700; }
    .High { background:#dc3545; color:#fff; }
    .Medium { background:#ffc107; color:#333; }
    .Low { background:#28a745; color:#fff; }

    /* Toast */
    #toast {
        position:fixed; right:20px; bottom:20px; background:#fff;
        padding:12px; display:none;
        border-left:6px solid #f5576c;
        border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.3);
        z-index:99999;
    }

    /* Modal */
    .modal {
        display:none; position:fixed; left:0; top:0; right:0; bottom:0;
        background:rgba(0,0,0,0.65);
        z-index:20000;
    }
    .modal .box {
        background:#fff; border-radius:10px;
        width:90%; max-width:900px; margin:40px auto; padding:18px;
        max-height:80vh; overflow-y:auto; position:relative;
    }
    .modal-close {
        position:absolute;
        top:12px;
        right:14px;
        font-size:28px;
        font-weight:700;
        color:#444;
        cursor:pointer;
        z-index:30000;
    }
    .modal-close:hover { color:#000; }

    @media (max-width:800px){
        .row { flex-direction:column; }
    }
</style>

</head>
<body>

<div class="navbar">
    <div class="title">RADAR — Real-Time Anomaly Detection</div>
    <div style="font-size:13px;color:#555;">Live</div>
</div>

<div class="container">

    <!-- Controls -->
    <div class="controls">
        <div style="color:#fff;font-weight:700;">Time:</div>
        <button class="btn active" onclick="setRange('buffer',this)">Live</button>
        <button class="btn" onclick="setRange('today',this)">Today</button>
        <button class="btn" onclick="setRange('yesterday',this)">Yesterday</button>
        <button class="btn" onclick="setRange('2days',this)">Last 2 days</button>
        <input id="startDT" type="datetime-local" step="1" />
        <input id="endDT" type="datetime-local" step="1" />
        <button class="btn" onclick="applyCustom()">Apply</button>

        <div style="width:20px;"></div>

        <div style="color:#fff;font-weight:700;">Filter:</div>
        <button class="btn" onclick="filterList('All')">All</button>
        <button class="btn" onclick="filterList('High')">High</button>
        <button class="btn" onclick="filterList('Medium')">Medium</button>
        <button class="btn" onclick="filterList('Low')">Low</button>
    </div>

    <!-- Metrics -->
    <div class="metrics">
        <div class="metric m1">
            <div>Total Anomalies</div>
            <div style="font-size:28px;font-weight:800" id="totalAnomalies">0</div>
        </div>
        <div class="metric m2">
            <div>Max Score</div>
            <div style="font-size:28px;font-weight:800" id="maxScore">0.00</div>
        </div>
        <div class="metric m3">
            <div>Total Events</div>
            <div style="font-size:28px;font-weight:800" id="totalEvents">0</div>
        </div>
    </div>

    <!-- Main line chart + Overall Pie -->
    <div class="row">
        <div class="col-2 card">
            <h3>Score vs Time (Clickable)</h3>
            <canvas id="mainChart" style="height:330px;"></canvas>
        </div>
        <div class="col-1 card">
            <h3>Severity Distribution (3D Pie)</h3>
            <div id="overallPie" style="height:310px;"></div>
            <small>Click a slice to filter anomalies</small>
        </div>
    </div>

    <!-- Detailed Asset-Based Pie Charts -->
    <div class="row">
        <div class="col-1 card">
            <h4>High Severity — Asset Breakdown</h4>
            <div id="pieHigh" style="height:260px;"></div>
        </div>
        <div class="col-1 card">
            <h4>Medium Severity — Asset Breakdown</h4>
            <div id="pieMedium" style="height:260px;"></div>
        </div>
        <div class="col-1 card">
            <h4>Low Severity — Asset Breakdown</h4>
            <div id="pieLow" style="height:260px;"></div>
        </div>
    </div>

    <!-- 3D scatter -->
    <div class="card">
        <h3>3D Scatter — Score vs Value vs Time</h3>
        <div id="scatter3d" style="height:420px;"></div>
        <div id="scatterExplanation" style="margin-top:6px;color:#444;"></div>
    </div>

    <!-- All anomalies -->
    <div class="card">
        <h3>All Anomalies</h3>
        <ul id="anomalyList"></ul>
    </div>

</div>

<div id="toast"></div>

<!-- Modal for Details -->
<div id="modal" class="modal">
    <div class="box">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h3>Event Details</h3>
        <p><strong>ID:</strong> <span id="d_id"></span></p>
        <p><strong>Timestamp:</strong> <span id="d_time"></span></p>
        <p><strong>Severity:</strong> <span id="d_sev"></span></p>
        <p><strong>Score:</strong> <span id="d_score"></span></p>
        <p><strong>Prediction:</strong> <span id="d_pred"></span></p>
        <p><strong>Asset:</strong> <span id="d_asset"></span></p>
        <p><strong>Reason:</strong> <span id="d_reason"></span></p>

        <h4>Raw Data</h4>
        <pre id="d_raw" style="background:#111;color:#fff;padding:10px;border-radius:8px;"></pre>

        <div id="assetFilterButton" style="margin-top:12px;"></div>
    </div>
</div>

<!-- Modal for Asset Breakdown Pie Click -->
<div id="assetModal" class="modal">
    <div class="box">
        <span class="modal-close" onclick="closeAssetModal()">&times;</span>
        <h3 id="assetModalTitle"></h3>
        <p id="assetModalInfo"></p>
        <div id="assetModalList"></div>
    </div>
</div>

<script>
/* GLOBAL STATE */
let mainChart;
let currentData = [];
let displayFilter = 'All';
let mode = 'buffer';

/* TOOLTIP FIX — hide tooltip after click */
function hideChartTooltip() {
    if (!mainChart) return;
    try {
        mainChart.tooltip.setActiveElements([], { x: 0, y: 0 });
        mainChart.update();
    } catch(e){ /* ignore */ }
}

/* Toast */
function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    setTimeout(()=>{ t.style.display='none'; },4000);
}

/* Clear all */
function clearAll(){
    if (mainChart) {
        mainChart.data.labels = [];
        mainChart.data.datasets.forEach(d=>d.data=[]);
        mainChart.update();
    }
    ['overallPie','pieHigh','pieMedium','pieLow','scatter3d'].forEach(id=>{ try{ Plotly.purge(id); } catch(e){} });
    document.getElementById('anomalyList').innerHTML = '<li style="padding:12px;background:#f2f2f2;border-left:4px solid #aaa;">No data for selected range</li>';
    document.getElementById('scatterExplanation').textContent='';
    document.getElementById('totalAnomalies').textContent='0';
    document.getElementById('maxScore').textContent='0.00';
    document.getElementById('totalEvents').textContent='0';
}

/* INIT MAIN CHART */
function initMainChart(){
    const ctx = document.getElementById('mainChart').getContext('2d');
    mainChart = new Chart(ctx,{
        type:'line',
        data:{
            labels:[],
            datasets:[
                { label:'Score', data:[], borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.15)', tension:0.2, fill:true },
                { label:'Anomaly', type:'scatter', data:[], pointRadius:6, backgroundColor:'#f5576c' }
            ]
        },
        options:{
            responsive:true,
            interaction: { mode:'nearest', intersect:true },
            onClick:(evt)=>{
                const pts = mainChart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
                if(pts && pts.length){
                    hideChartTooltip();
                    const p = pts[0];
                    if(p.datasetIndex===1){
                        const obj = mainChart.data.datasets[1].data[p.index].ref;
                        if(obj) openDetailModal(obj);
                    } else {
                        const label = mainChart.data.labels[p.index];
                        const match = currentData.find(a=> new Date(a.timestamp).toLocaleString()===label);
                        if(match) openDetailModal(match);
                    }
                }
            }
        }
    });
}

/* LOAD DATA */
async function loadData(){
    let url='/api/anomalies';
    if(mode!=='buffer'){
        if(mode==='custom'){
            const s=document.getElementById('startDT').value;
            const e=document.getElementById('endDT').value;
            if(!s||!e){ alert('Pick start & end'); return; }
            url=`/api/anomalies/history?start=${encodeURIComponent(s)}&end=${encodeURIComponent(e)}`;
        } else {
            url=`/api/anomalies/history?range=${mode}`;
        }
    }

    try{
        const res = await fetch(url);
        const json = await res.json();
        const data = json.anomalies || [];
        if(!data.length){ clearAll(); return; }
        currentData = data;
        updateCharts(data);
    } catch(err){
        console.error(err);
        showToast('Connection error');
        clearAll();
    }
}

/* UPDATE CHARTS */
function updateCharts(data){
    document.getElementById('totalAnomalies').textContent = data.filter(a=>a.is_anomaly).length;
    document.getElementById('maxScore').textContent = Math.max(...data.map(a=>a.anomaly_score||0)).toFixed(4);
    document.getElementById('totalEvents').textContent = data.length;

    const labels = data.map(a=> new Date(a.timestamp).toLocaleString());
    const scores = data.map(a=> a.value);
    const pts = data.filter(a=>a.is_anomaly).map(a=>({ x:new Date(a.timestamp).toLocaleString(), y:a.value, ref:a }));

    mainChart.data.labels = labels;
    mainChart.data.datasets[0].data = scores;
    mainChart.data.datasets[1].data = pts;
    mainChart.update();

    renderAnomalyList();
    renderOverallPie(data);
    renderDetailedPies(data);
    renderScatter(data);
}

/* ANOMALY LIST */
function renderAnomalyList(assetFilter=null){
    const ul = document.getElementById('anomalyList');
    ul.innerHTML='';
    let arr = [...currentData];
    if(displayFilter!=='All') arr = arr.filter(a=>a.severity===displayFilter);
    if(assetFilter) arr = arr.filter(a=>a.asset_id===assetFilter);

    if(!arr.length){
        ul.innerHTML = '<li style="padding:12px;background:#eee;">No anomalies in this filter</li>';
        return;
    }

    arr.slice().reverse().forEach(a=>{
        const li=document.createElement('li');
        li.innerHTML = `<div style="display:flex;justify-content:space-between;"><div><strong>ID:</strong> ${a.id}</div><div><span class="sev ${a.severity}">${a.severity}</span></div></div>
                        <div><small>${new Date(a.timestamp).toLocaleString()}</small></div>
                        <div style="margin-top:6px;"><strong>Score:</strong> ${a.anomaly_score.toFixed(6)} • <strong>Asset:</strong> ${a.asset_id}</div>
                        <div style="color:#666;margin-top:6px;">${a.reason}</div>`;
        li.onclick = ()=> openDetailModal(a);
        ul.appendChild(li);
    });
}

/* FILTER LIST */
function filterList(sev){
    displayFilter = sev;
    renderAnomalyList();
}

/* OVERALL PIE */
function renderOverallPie(data){
    const counts={High:0,Medium:0,Low:0};
    data.forEach(a=> counts[a.severity] = (counts[a.severity]||0)+1);
    Plotly.newPlot('overallPie',[{ labels:['High','Medium','Low'], values:[counts.High,counts.Medium,counts.Low], type:'pie', hole:0.25, textinfo:'label+value+percent' }],
        {margin:{t:10,b:10,l:10,r:10},height:310},{displayModeBar:false}).then(gd=>{
            gd.on('plotly_click', ev=>{
                const label = ev.points[0].label;
                filterList(label);
            });
        });
}

/* DETAILED PIE CHARTS (ASSET BREAKDOWN) */
function renderDetailedPies(data){
    const groups={High:[],Medium:[],Low:[]};
    data.forEach(a=> groups[a.severity].push(a));

    function draw(id, arr){
        const counts={};
        arr.forEach(a=> counts[a.asset_id] = (counts[a.asset_id]||0)+1);
        const labels = Object.keys(counts);
        const values = labels.map(l=>counts[l]);
        if(labels.length===0){
            document.getElementById(id).innerHTML = '<div style="padding:12px;color:#666;">No data</div>';
            return;
        }
        Plotly.newPlot(id,[{ labels, values, type:'pie', hole:0.35, textinfo:'label+percent' }],{height:260, margin:{t:10,b:10}}, {displayModeBar:false}).then(gd=>{
            gd.on('plotly_click', ev=>{
                const asset = ev.points[0].label;
                const severity = (id==='pieHigh')?'High':(id==='pieMedium')?'Medium':'Low';
                openAssetModal(severity, asset, arr);
            });
        });
    }

    draw('pieHigh', groups.High);
    draw('pieMedium', groups.Medium);
    draw('pieLow', groups.Low);
}

/* ASSET MODAL */
function openAssetModal(severity, asset, arr){
    const modal = document.getElementById('assetModal');
    modal.style.display='block';
    document.getElementById('assetModalTitle').textContent = `${severity} — Asset: ${asset}`;
    const filtered = arr.filter(a=> a.asset_id===asset);
    document.getElementById('assetModalInfo').innerHTML = `Total events: <b>${filtered.length}</b>`;
    const listDiv = document.getElementById('assetModalList');
    listDiv.innerHTML = filtered.slice(0,12).map(a=>`<div style="padding:8px;border-bottom:1px solid #eee;"><b>ID:</b> ${a.id} • <b>Score:</b> ${a.anomaly_score.toFixed(6)} • <b>Time:</b> ${new Date(a.timestamp).toLocaleString()}</div>`).join('');
    listDiv.innerHTML += `<div style="margin-top:12px;"><button class="btn" onclick="applyAssetFilter('${asset}')">Filter by this Asset</button></div>`;
}
function closeAssetModal(){ document.getElementById('assetModal').style.display='none'; }
function applyAssetFilter(asset){ closeAssetModal(); renderAnomalyList(asset); filterList('All'); }

/* SCATTER */
function renderScatter(data){
    const x=[], y=[], z=[], text=[];
    data.forEach(a=>{
        x.push(a.anomaly_score);
        y.push(a.value);
        z.push(new Date(a.timestamp).getTime());
        text.push(`ID:${a.id}<br>${a.severity}<br>${new Date(a.timestamp).toLocaleString()}`);
    });
    Plotly.newPlot('scatter3d',[{ x,y,z,text,mode:'markers', marker:{size:5,color:x,colorscale:'Viridis'}, type:'scatter3d' }],{height:420, margin:{t:10}, scene:{ xaxis:{title:'Score'}, yaxis:{title:'Value'}, zaxis:{title:'Time'} }},{displayModeBar:false});
    const max = Math.max(...data.map(d=>d.anomaly_score||0)).toFixed(4);
    const min = Math.min(...data.map(d=>d.anomaly_score||0)).toFixed(4);
    const high = data.filter(d=>d.severity==='High').length;
    document.getElementById('scatterExplanation').textContent = `Total: ${data.length} • High: ${high} • Score range: ${min} — ${max}`;
}

/* DETAIL MODAL */
function openDetailModal(a){
    document.getElementById('d_id').textContent = a.id;
    document.getElementById('d_time').textContent = a.timestamp;
    document.getElementById('d_sev').textContent = a.severity;
    document.getElementById('d_score').textContent = a.anomaly_score.toFixed(6);
    document.getElementById('d_pred').textContent = a.prediction;
    document.getElementById('d_asset').textContent = a.asset_id;
    document.getElementById('d_reason').textContent = a.reason;
    try { document.getElementById('d_raw').textContent = JSON.stringify(JSON.parse(a.raw_data), null, 2); } catch { document.getElementById('d_raw').textContent = a.raw_data; }
    document.getElementById('assetFilterButton').innerHTML = `<button class="btn" onclick="applyAssetFilter('${a.asset_id}')">Filter by Asset: ${a.asset_id}</button>`;
    document.getElementById('modal').style.display = 'block';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }

/* TIME CONTROLS */
function setRange(r,btn){
    mode=r;
    document.querySelectorAll('.controls .btn').forEach(b=>b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    loadData();
}
function applyCustom(){ mode='custom'; loadData(); }

/* LOAD */
async function loadData(){
    let url='/api/anomalies';
    if(mode!=='buffer'){
        if(mode==='custom'){
            const s=document.getElementById('startDT').value; const e=document.getElementById('endDT').value;
            if(!s||!e){ alert('Pick start & end datetimes'); return; }
            if(new Date(s) >= new Date(e)){ alert('Start must be before End'); return; }
            url=`/api/anomalies/history?start=${encodeURIComponent(s)}&end=${encodeURIComponent(e)}`;
        } else url=`/api/anomalies/history?range=${mode}`;
    }
    try{
        const res = await fetch(url);
        const json = await res.json();
        const data = json.anomalies || [];
        if(!data.length){ clearAll(); return; }
        currentData = data;
        updateCharts(data);
    } catch(err){ console.error(err); showToast('Connection error'); clearAll(); }
}

/* KEY + OUTSIDE CLICK CLOSE */
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ closeModal(); closeAssetModal(); } });
window.addEventListener('click',(ev)=>{
    const modal = document.getElementById('modal');
    const assetModal = document.getElementById('assetModal');
    if(ev.target===modal) closeModal();
    if(ev.target===assetModal) closeAssetModal();
});

/* START */
document.addEventListener('DOMContentLoaded',()=>{ initMainChart(); loadData(); setInterval(()=>{ if(mode==='buffer') loadData(); },3000); });
</script>

</body>
</html>
